<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width initial-scale=1" />

    <link rel="stylesheet" type="text/css" href="style.css" />
    <title>11-gRPC-Streams</title>
  </head>
  <body class="typora-export os-windows">
    <div class="typora-export-content">
      <div id="write" class="">
        <h1 id="streams"><span>gRPC - Streams</span></h1>
        <p>
          <span
            >Performance-Thema in gRPC. 3 verschiedene Modi: Server &gt; Client,
            Client &gt; Server, Bidirektional.</span
          >
        </p>
        <p>
          <span
            >End-To-End Reliability, garantiertes Ausliefern der
            Nachrichten</span
          >
          <span>Ordered Delivery: Reihenfolge gew√§hrleistet</span>
        </p>
        <p>
          <span
            >Anwendungen: Messaging, Games, Live-Resultate, Smart Home Devices
            etc.</span
          >
        </p>
        <p><span>Synchrones Lesen vs. Streaming</span></p>
        <h2 id="protobuf-implementation">
          <span>Protobuf Implementation</span>
        </h2>
        <pre
          class="md-fences md-end-block ty-contain-cm modeLoaded"
          spellcheck="false"
          lang="protobuf"
        ><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="protobuf"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 11px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">service</span> <span class="cm-variable">FileStreamingService</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">rpc</span> <span class="cm-variable">ReadFiles</span> (<span class="cm-variable">google</span>.<span class="cm-variable">protobuf</span>.<span class="cm-variable">Empty</span>)<span class="cm-tab" role="presentation" cm-text="	">   </span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">returns</span> (<span class="cm-variable">stream</span> <span class="cm-variable">FileDto</span>);<span class="cm-tab" role="presentation" cm-text="	">   </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">// Server Streaming Call</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">rpc</span> <span class="cm-variable">SendFiles</span> (<span class="cm-variable">stream</span> <span class="cm-variable">FileDto</span>)<span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">returns</span> (<span class="cm-variable">google</span>.<span class="cm-variable">protobuf</span>.<span class="cm-variable">Empty</span>);<span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">// Client Streaming Call</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">rpc</span> <span class="cm-variable">RoundtripFiles</span> (<span class="cm-variable">stream</span> <span class="cm-variable">FileDto</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">returns</span> (<span class="cm-variable">stream</span> <span class="cm-variable">FileDto</span>);<span class="cm-tab" role="presentation" cm-text="	">   </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">// Bidirektional</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">message</span> <span class="cm-variable">FileDto</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">string</span> <span class="cm-variable">file_name</span> = <span class="cm-number">1</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">int32</span> <span class="cm-variable">line</span> = <span class="cm-number">2</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">string</span> <span class="cm-variable">content</span> = <span class="cm-number">3</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 349px;"></div><div class="CodeMirror-gutters" style="display: none; height: 349px;"></div></div></div></pre>
        <h2 id="c-implementation"><span>C# Implementation</span></h2>
        <h3 id="api-klassen"><span>API Klassen</span></h3>
        <p>
          <code>AsyncServerStreamingCall&lt;TResponse&gt;</code>
          <code>AsyncClientStreamingCall&lt;TRequest, TResponse&gt;</code>
          <code>AsyncDuplexStreamingCall&lt;TRequest, TResponse&gt;</code>
        </p>
        <p>
          <span>Interfaces: </span><code>IAsyncStreamReader&lt;T&gt;</code
          ><span>, </span><code>IClientStreamWriter&lt;T&gt;</code>
        </p>
        <p>&nbsp;</p>
        <p>
          <img src=".\res\csharp-streaming-api.png" />
        </p>
        <h3 id="server-streaming-call"><span>Server Streaming Call</span></h3>
        <pre
          class="md-fences md-end-block ty-contain-cm modeLoaded"
          spellcheck="false"
          lang="csharp"
          style="break-inside: unset"
        ><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="csharp"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 11px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// Service</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">override</span> <span class="cm-keyword">async</span> <span class="cm-variable-3">Task</span> <span class="cm-def">ReadFiles</span>(</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">Empty</span> <span class="cm-variable">request</span>, </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">IServerStreamWriter</span><span class="cm-operator">&lt;</span><span class="cm-variable">FileDto</span><span class="cm-operator">&gt;</span> <span class="cm-variable">responseStream</span>, </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">ServerCallContext</span> <span class="cm-variable">context</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable-3">string</span> [] <span class="cm-variable">files</span> <span class="cm-operator">=</span> <span class="cm-variable">Directory</span>.<span class="cm-variable">GetFiles</span>(<span class="cm-string">@"..."</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">foreach</span> (<span class="cm-variable-3">string</span> <span class="cm-variable">file</span> <span class="cm-keyword">in</span> <span class="cm-variable">files</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable-3">string</span> <span class="cm-variable">content</span>; <span class="cm-variable-3">int</span> <span class="cm-variable">line</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">using</span> <span class="cm-variable">StreamReader</span> <span class="cm-variable">reader</span> <span class="cm-operator">=</span> <span class="cm-variable">File</span>.<span class="cm-variable">OpenText</span>(<span class="cm-variable">file</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">while</span> ((<span class="cm-variable">content</span> <span class="cm-operator">=</span> <span class="cm-keyword">await</span> <span class="cm-variable">reader</span>.<span class="cm-variable">ReadLineAsync</span>()) <span class="cm-operator">!=</span> <span class="cm-atom">null</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">line</span><span class="cm-operator">++</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">FileDto</span> <span class="cm-variable">reply</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span>()</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">FileName</span> <span class="cm-operator">=</span> <span class="cm-variable">file</span>, <span class="cm-variable">Line</span> <span class="cm-operator">=</span> <span class="cm-variable">line</span>, <span class="cm-variable">Content</span> <span class="cm-operator">=</span> <span class="cm-variable">content</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  };</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">await</span> <span class="cm-variable">responseStream</span>.<span class="cm-variable">WriteAsync</span>(<span class="cm-variable">reply</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// Client</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">using</span> <span class="cm-variable">AsyncServerStreamingCall</span><span class="cm-operator">&lt;</span><span class="cm-variable">FileDto</span><span class="cm-operator">&gt;</span> <span class="cm-variable">call</span> <span class="cm-operator">=</span> <span class="cm-variable">client</span>.<span class="cm-variable">ReadFiles</span>(<span class="cm-keyword">new</span> <span class="cm-variable">Empty</span>());</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">await</span> <span class="cm-keyword">foreach</span> (<span class="cm-variable">FileDto</span> <span class="cm-variable">message</span> <span class="cm-keyword">in</span> <span class="cm-variable">call</span>.<span class="cm-variable">ResponseStream</span>.<span class="cm-variable">ReadAllAsync</span>())</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">WriteLine</span>(<span class="cm-variable">$</span><span class="cm-string">"File: {message.FileName}, Line Nr: {message.Line}, Content: {message.Content}"</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 728px;"></div><div class="CodeMirror-gutters" style="display: none; height: 728px;"></div></div></div></pre>
        <h3 id="client-streaming-call"><span>Client Streaming Call</span></h3>
        <pre
          class="md-fences md-end-block ty-contain-cm modeLoaded"
          spellcheck="false"
          lang="csharp"
          style="break-inside: unset"
        ><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="csharp"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 11px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">//Service</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">override</span> <span class="cm-keyword">async</span> <span class="cm-variable-3">Task</span><span class="cm-operator">&lt;</span><span class="cm-variable">Empty</span><span class="cm-operator">&gt;</span> <span class="cm-def">SendFiles</span>(<span class="cm-variable">IAsyncStreamReader</span><span class="cm-operator">&lt;</span><span class="cm-variable">FileDto</span><span class="cm-operator">&gt;</span> <span class="cm-variable">requestStream</span>, <span class="cm-variable">ServerCallContext</span> <span class="cm-variable">context</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">await</span> <span class="cm-keyword">foreach</span> (<span class="cm-variable">FileDto</span> <span class="cm-variable">message</span> <span class="cm-keyword">in</span> <span class="cm-variable">requestStream</span>.<span class="cm-variable">ReadAllAsync</span>())</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>{ <span class="cm-variable">WriteLine</span>(<span class="cm-variable">$</span><span class="cm-string">"File: {message.FileName}, Line Nr: {message.Line}, Line Content: {message.Content}"</span>);<span class="cm-tab" role="presentation" cm-text="	"> </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">return</span> <span class="cm-keyword">new</span> <span class="cm-variable">Empty</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// Client</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">using</span> <span class="cm-variable">AsyncClientStreamingCall</span><span class="cm-operator">&lt;</span><span class="cm-variable">FileDto</span>, <span class="cm-variable">Empty</span><span class="cm-operator">&gt;</span> <span class="cm-variable">call</span> <span class="cm-operator">=</span> <span class="cm-variable">client</span>.<span class="cm-variable">SendFiles</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-3">string</span>[] <span class="cm-variable">files</span> <span class="cm-operator">=</span> <span class="cm-variable">Directory</span>.<span class="cm-variable">GetFiles</span>(<span class="cm-string">@"Files"</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">foreach</span> (<span class="cm-variable-3">string</span> <span class="cm-variable">file</span> <span class="cm-keyword">in</span> <span class="cm-variable">files</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable-3">string</span> <span class="cm-variable">content</span>; <span class="cm-variable-3">int</span> <span class="cm-variable">line</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">using</span> <span class="cm-variable">StreamReader</span> <span class="cm-variable">reader</span> <span class="cm-operator">=</span> <span class="cm-variable">File</span>.<span class="cm-variable">OpenText</span>(<span class="cm-variable">file</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">while</span> ((<span class="cm-variable">content</span> <span class="cm-operator">=</span> <span class="cm-keyword">await</span> <span class="cm-variable">reader</span>.<span class="cm-variable">ReadLineAsync</span>()) <span class="cm-operator">!=</span> <span class="cm-atom">null</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">line</span><span class="cm-operator">++</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">FileDto</span> <span class="cm-variable">reply</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span>() { <span class="cm-variable">FileName</span> <span class="cm-operator">=</span> <span class="cm-variable">file</span>, <span class="cm-variable">Line</span> <span class="cm-operator">=</span> <span class="cm-variable">line</span>, <span class="cm-variable">Content</span> <span class="cm-operator">=</span> <span class="cm-variable">content</span> };</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">await</span> <span class="cm-variable">call</span>.<span class="cm-variable">RequestStream</span>.<span class="cm-variable">WriteAsync</span>(<span class="cm-variable">reply</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// Required!</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">await</span> <span class="cm-variable">call</span>.<span class="cm-variable">RequestStream</span>.<span class="cm-variable">CompleteAsync</span>(); <span class="cm-comment">// No more messages to come (server exits foreach-Loop)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">Empty</span> <span class="cm-variable">result</span> <span class="cm-operator">=</span> <span class="cm-keyword">await</span> <span class="cm-variable">call</span>; <span class="cm-comment">// Wait until service method is terminated / Get the result</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 628px;"></div><div class="CodeMirror-gutters" style="display: none; height: 628px;"></div></div></div></pre>
        <h3 id="bidirectional--duplex-streaming-call">
          <span>Bidirectional / Duplex Streaming Call</span>
        </h3>
        <pre
          class="md-fences md-end-block ty-contain-cm modeLoaded"
          spellcheck="false"
          lang="csharp"
          style="break-inside: unset"
        ><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="csharp"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 11px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// Service</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">override</span> <span class="cm-keyword">async</span> <span class="cm-variable-3">Task</span> <span class="cm-def">RoundtripFiles</span>(</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">IAsyncStreamReader</span><span class="cm-operator">&lt;</span><span class="cm-variable">FileDto</span><span class="cm-operator">&gt;</span> <span class="cm-variable">requestStream</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">IServerStreamWriter</span><span class="cm-operator">&lt;</span><span class="cm-variable">FileDto</span><span class="cm-operator">&gt;</span> <span class="cm-variable">responseStream</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">ServerCallContext</span> <span class="cm-variable">context</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">await</span> <span class="cm-keyword">foreach</span> (<span class="cm-variable">FileDto</span> <span class="cm-variable">message</span> <span class="cm-keyword">in</span> <span class="cm-variable">requestStream</span>.<span class="cm-variable">ReadAllAsync</span>())</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">await</span> <span class="cm-variable">responseStream</span>.<span class="cm-variable">WriteAsync</span>(<span class="cm-variable">message</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">WriteLine</span>(<span class="cm-variable">$</span><span class="cm-string">"File: {message.FileName}, Line Nr: {message.Line}, Line Content: {message.Content}"</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// Client</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">using</span> <span class="cm-variable">AsyncDuplexStreamingCall</span><span class="cm-operator">&lt;</span><span class="cm-variable">FileDto</span>, <span class="cm-variable">FileDto</span><span class="cm-operator">&gt;</span> <span class="cm-variable">call</span> <span class="cm-operator">=</span> <span class="cm-variable">client</span>.<span class="cm-variable">RoundtripFiles</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// Read</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-3">Task</span> <span class="cm-variable">readTask</span> <span class="cm-operator">=</span> <span class="cm-variable-3">Task</span>.<span class="cm-variable">Run</span>(<span class="cm-keyword">async</span> () <span class="cm-operator">=&gt;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">await</span> <span class="cm-keyword">foreach</span> (<span class="cm-variable">FileDto</span> <span class="cm-variable">message</span> <span class="cm-keyword">in</span> <span class="cm-variable">call</span>.<span class="cm-variable">ResponseStream</span>.<span class="cm-variable">ReadAllAsync</span>())</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">WriteLine</span>(<span class="cm-variable">$</span><span class="cm-string">"File: {message.FileName}, Line Nr: {message.Line}, Line Content: {message.Content}"</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">});</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// Write</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-3">string</span>[] <span class="cm-variable">files</span> <span class="cm-operator">=</span> <span class="cm-variable">Directory</span>.<span class="cm-variable">GetFiles</span>(<span class="cm-string">@"Files"</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">foreach</span> (<span class="cm-variable-3">string</span> <span class="cm-variable">file</span> <span class="cm-keyword">in</span> <span class="cm-variable">files</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable-3">string</span> <span class="cm-variable">content</span>; <span class="cm-variable-3">int</span> <span class="cm-variable">line</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">using</span> <span class="cm-variable">StreamReader</span> <span class="cm-variable">reader</span> <span class="cm-operator">=</span> <span class="cm-variable">File</span>.<span class="cm-variable">OpenText</span>(<span class="cm-variable">file</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">while</span> ((<span class="cm-variable">content</span> <span class="cm-operator">=</span> <span class="cm-keyword">await</span> <span class="cm-variable">reader</span>.<span class="cm-variable">ReadLineAsync</span>()) <span class="cm-operator">!=</span> <span class="cm-atom">null</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">line</span><span class="cm-operator">++</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">FileDto</span> <span class="cm-variable">reply</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span>()</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  { <span class="cm-variable">FileName</span> <span class="cm-operator">=</span> <span class="cm-variable">file</span>, <span class="cm-variable">Line</span> <span class="cm-operator">=</span> <span class="cm-variable">line</span>, <span class="cm-variable">Content</span> <span class="cm-operator">=</span> <span class="cm-variable">content</span> };</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">await</span> <span class="cm-variable">call</span>.<span class="cm-variable">RequestStream</span>.<span class="cm-variable">WriteAsync</span>(<span class="cm-variable">reply</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// Required!</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">await</span> <span class="cm-variable">call</span>.<span class="cm-variable">RequestStream</span>.<span class="cm-variable">CompleteAsync</span>(); <span class="cm-comment">// No more messages to come (server exits foreach-Loop)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">await</span> <span class="cm-variable">readTask</span>; <span class="cm-comment">// Wait until service method is terminated / all messages are received by clien</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 1014px;"></div><div class="CodeMirror-gutters" style="display: none; height: 1014px;"></div></div></div></pre>
      </div>
    </div>
  </body>
</html>
