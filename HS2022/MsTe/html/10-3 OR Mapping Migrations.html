<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width initial-scale=1" />
    <link rel="stylesheet" type="text/css" href="style.css" />

    <title>10-3 OR Mapping Migrations</title>
  </head>
  <body class="typora-export os-windows">
    <div class="typora-export-content">
      <div id="write" class="">
        <h1 id="or-mapping-advanced-migrations">
          <span>OR Mapping Advanced, Migrations</span>
        </h1>
        <p>
          <span
            >Verschiedene Punkte können in relationalen Datenbanken nicht direkt
            1:1 umgesetzt werden wie im Code.</span
          >
        </p>
        <h2 id="vererbung"><span>Vererbung</span></h2>
        <p>
          <span
            >Vorteile: Constraints können über Vererbung einfach abgebildet
            werden. Bsp: Feld x darf für einen abgeleiteten Typen nicht gesetzt
            sein, beim anderen ist es zwingend.</span
          >
        </p>
        <p>
          <span
            >Potenzielle Probleme führen dazu, dass diese Varianten oftmals gar
            nicht angewendet werden:</span
          >
        </p>
        <ul>
          <li><span>Ungenutzte Felder / Speicherplatz</span></li>
          <li><span>Zu viele Tabellen</span></li>
          <li><span>Inkonsistenzen</span></li>
        </ul>
        <p>
          <span
            >Verschiedene Ansätze existieren zur Modellierung von Vererbung in
            einer Datenbank:</span
          >
        </p>
        <h3 id="table-per-hierarchy-ef-core-standard">
          <span>Table per Hierarchy (EF Core Standard)</span>
        </h3>
        <p>
          <span
            >Nur über DB Context definierbar. Abgeleitete Klassen werden als
            separate DbSet-Properties der Basisklasse definiert, oder via Model
            Builder separat:</span
          >
        </p>
        <pre
          class="md-fences md-end-block ty-contain-cm modeLoaded"
          spellcheck="false"
          lang="csharp"
        ><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="csharp"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 11px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">modelBuilder</span>.<span class="cm-variable">Entity</span><span class="cm-operator">&lt;</span><span class="cm-variable">Tablet</span><span class="cm-operator">&gt;</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  .<span class="cm-variable">HasBaseType</span><span class="cm-operator">&lt;</span><span class="cm-variable">Product</span><span class="cm-operator">&gt;</span>();</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 52px;"></div><div class="CodeMirror-gutters" style="display: none; height: 52px;"></div></div></div></pre>
        <p>
          <span
            >In der Datenbank wird ein Feld als Diskriminator eingefügt,
            standardmässig der Name der Klasse. Dies kann bei Refactorings
            problematisch sein. Deshalb kann der Diskriminator auch übersteuert
            werden, dann muss jeder instanzierbare Typ definiert sein. Die
            Basisklasse kann abstrakt definiert werden.</span
          >
        </p>
        <pre
          class="md-fences md-end-block ty-contain-cm modeLoaded"
          spellcheck="false"
          lang="csharp"
        ><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="csharp"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 11px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">modelBuilder</span>.<span class="cm-variable">Entity</span><span class="cm-operator">&lt;</span><span class="cm-variable">Product</span><span class="cm-operator">&gt;</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  .<span class="cm-variable">HasDiscriminator</span><span class="cm-operator">&lt;</span><span class="cm-variable-3">int</span><span class="cm-operator">&gt;</span>(<span class="cm-string">"ProductType"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  .<span class="cm-variable">HasValue</span><span class="cm-operator">&lt;</span><span class="cm-variable">Product</span><span class="cm-operator">&gt;</span>(<span class="cm-number">0</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  .<span class="cm-variable">HasValue</span><span class="cm-operator">&lt;</span><span class="cm-variable">MobilePhone</span><span class="cm-operator">&gt;</span>(<span class="cm-number">1</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  .<span class="cm-variable">HasValue</span><span class="cm-operator">&lt;</span><span class="cm-variable">Tablet</span><span class="cm-operator">&gt;</span>(<span class="cm-number">2</span>);</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 130px;"></div><div class="CodeMirror-gutters" style="display: none; height: 130px;"></div></div></div></pre>
        <h3 id="table-per-type"><span>Table per Type</span></h3>
        <p>
          <span>Vorteil: keine NULL-Felder, Überblick über alle Produkte </span>
          <span
            >Nachteil: immer Left Joins nötig, wenn alle Informationen benötigt
            werden.</span
          >
        </p>
        <figure>
          <table>
            <thead>
              <tr>
                <th><span>Tabelle</span></th>
                <th><span>Felder</span></th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><span>Products</span></td>
                <td><span>Id, Name, Description, Price</span></td>
              </tr>
              <tr>
                <td><span>MobilePhones</span></td>
                <td><span>Id (FK), OperatingSystem, SupportsUmts</span></td>
              </tr>
              <tr>
                <td><span>Tablets</span></td>
                <td><span>Id (FK), HasKeyboard</span></td>
              </tr>
            </tbody>
          </table>
        </figure>
        <h3 id="table-per-concrete-type">
          <span>Table per Concrete Type</span>
        </h3>
        <p>
          <span>Vorteil: Einzelne Produkte sind einfach abrufbar</span>
          <span
            >Nachteil: Gesamtüberblick über alle Produkte ist schwieriger</span
          >
        </p>
        <figure>
          <table>
            <thead>
              <tr>
                <th><span>Tabelle</span></th>
                <th><span>Felder</span></th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><span>Products</span></td>
                <td><span>Id, Name, Description, Price</span></td>
              </tr>
              <tr>
                <td><span>MobilePhones</span></td>
                <td>
                  <span
                    >Id, Name, Description, Price, OperatingSystem,
                    SupportsUmts</span
                  >
                </td>
              </tr>
              <tr>
                <td><span>Tablets</span></td>
                <td><span>Id, Name, Description, Price, HasKeyboard</span></td>
              </tr>
            </tbody>
          </table>
        </figure>
        <h2 id="entity--table-splitting">
          <span>Entity / Table Splitting</span>
        </h2>
        <p>
          <span
            >Mittels Table Splitting können unter anderem mehrere Entitäten auf
            eine Tabelle gemappt werden. Inheritance (Table per Hierarchy) ist
            nur eine Variante davon.</span
          >
        </p>
        <h3
          id="xxxxxxxxxx var-currentassembly--assemblygetexecutingassemblyvar-classinfo--currentassemblygettypesforeach-var-classtype-in-classinfo--auf-jeder-klasse-im-assembly- - if-classtypeisdefinedtypeoftableattribute-- - -wenn-das-gesuchte-attribute-gesetzt-ist- --- - - - consolewritelinenklasse-classtypename- - - - foreach-var-a-in-classtypecustomattributes--für-jedes-attribut- - - --- - - - - - if-aattributetypetostring--12attributetableattribute-- - - - - - - - -das-gesuchte-ausgeben- - - - - - - - consolewritelineattribute-argument1-aconstructorarguments0tostring- - - --- --csharp"
        >
          <span
            >xxxxxxxxxx var currentAssembly =
            Assembly.GetExecutingAssembly();var classInfo =
            currentAssembly.GetTypes();​foreach (var classType in classInfo) //
            Auf jeder Klasse im Assembly{    if
            (classType.IsDefined(typeof(TableAttribute)))    // Wenn das
            gesuchte Attribute gesetzt ist   {      
             Console.WriteLine($&quot;\nKlasse: {classType.Name}&quot;);      
             foreach (var a in classType.CustomAttributes) // für jedes Attribut
                  {            if (a.AttributeType.ToString() == &quot;</span
          ><em><span>1.</span></em
          ><span
            >2_Attribute.TableAttribute&quot;)                // das gesuchte
            ausgeben              
             Console.WriteLine($&quot;Attribute-Argument1:
            {a.ConstructorArguments[0].ToString()}&quot;);       }  
            }}csharp</span
          >
        </h3>
        <p>
          <span
            >Zwei Entitäten auf die gleiche Tabelle mappen. Nur mit FluentAPI
            möglich. Performance: ermöglicht Abfrage von entweder nur Header
            Daten oder allen Details</span
          >
        </p>
        <pre
          class="md-fences md-end-block ty-contain-cm modeLoaded"
          spellcheck="false"
          lang="csharp"
          style="break-inside: unset"
        ><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="csharp"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 11px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">class</span> <span class="cm-def">ShopContext</span> : <span class="cm-variable">DbContext</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable">DbSet</span><span class="cm-operator">&lt;</span><span class="cm-variable">Customer</span><span class="cm-operator">&gt;</span> <span class="cm-variable">Customers</span> { <span class="cm-keyword">get</span>; <span class="cm-keyword">set</span>; }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">protected</span> <span class="cm-keyword">override</span> <span class="cm-keyword">void</span> <span class="cm-variable">OnModelCreating</span>(<span class="cm-variable">ModelBuilder</span> <span class="cm-variable">modelBuilder</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  <span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">modelBuilder</span>.<span class="cm-variable">Entity</span><span class="cm-operator">&lt;</span><span class="cm-variable">CustomerDetail</span><span class="cm-operator">&gt;</span>(<span class="cm-variable">e</span> <span class="cm-operator">=&gt;</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  <span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">e</span>.<span class="cm-variable">ToTable</span>(<span class="cm-string">"Customers"</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  <span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">// Map all Detail-Properties</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  <span class="cm-tab" role="presentation" cm-text="	">    </span>});</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">modelBuilder</span>.<span class="cm-variable">Entity</span><span class="cm-operator">&lt;</span><span class="cm-variable">Customer</span><span class="cm-operator">&gt;</span>(<span class="cm-variable">e</span> <span class="cm-operator">=&gt;</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  <span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">e</span>.<span class="cm-variable">ToTable</span>(<span class="cm-string">"Customers"</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  <span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">// Map Properties</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  <span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">e</span>.<span class="cm-variable">HasOne</span>(<span class="cm-variable">o</span> <span class="cm-operator">=&gt;</span> <span class="cm-variable">o</span>.<span class="cm-variable">Details</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  <span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span>.<span class="cm-variable">WithOne</span>()</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  <span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span>.<span class="cm-variable">HasForeignKey</span><span class="cm-operator">&lt;</span><span class="cm-variable">CustomerDetail</span><span class="cm-operator">&gt;</span>(<span class="cm-variable">o</span> <span class="cm-operator">=&gt;</span> <span class="cm-variable">o</span>.<span class="cm-variable">Id</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span> &nbsp;  });</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 481px;"></div><div class="CodeMirror-gutters" style="display: none; height: 481px;"></div></div></div></pre>
        <h3 id="owned-types"><span>Owned Types</span></h3>
        <p>
          <span
            >Owned Type hat keinen Primary Key, deshalb keine Convention
            möglich. Felder des Owned Property in der Tabelle erhalten einen
            zusammengesetzten Namen aus </span
          ><em><span>OwnedType_Property</span></em
          ><span>: bsp. </span><code>Address_Street</code>
        </p>
        <pre
          class="md-fences md-end-block ty-contain-cm modeLoaded"
          spellcheck="false"
          lang="csharp"
          style="break-inside: unset"
        ><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="csharp"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 11px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">class</span> <span class="cm-def">ShopContext</span> : <span class="cm-variable">DbContext</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable">DbSet</span><span class="cm-operator">&lt;</span><span class="cm-variable">Customer</span><span class="cm-operator">&gt;</span> <span class="cm-variable">Customers</span> { <span class="cm-keyword">get</span>; <span class="cm-keyword">set</span>; }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">protected</span> <span class="cm-keyword">override</span> <span class="cm-keyword">void</span> <span class="cm-variable">OnModelCreating</span>(<span class="cm-variable">ModelBuilder</span> <span class="cm-variable">modelBuilder</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">modelBuilder</span>.<span class="cm-variable">Entity</span><span class="cm-operator">&lt;</span><span class="cm-variable">Customer</span><span class="cm-operator">&gt;</span>()</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  .<span class="cm-variable">OwnsOne</span>(<span class="cm-variable">b</span> <span class="cm-operator">=&gt;</span> <span class="cm-variable">b</span>.<span class="cm-variable">Address</span>);<span class="cm-tab" role="presentation" cm-text="	">   </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">// Variante FluentAPI</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">class</span> <span class="cm-def">Customer</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable-3">int</span> <span class="cm-variable">Id</span> { <span class="cm-keyword">get</span>; <span class="cm-keyword">set</span>; }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable">Address</span> <span class="cm-variable">Address</span> { <span class="cm-keyword">get</span>; <span class="cm-keyword">set</span>; }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">[<span class="cm-variable">Owned</span>] <span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">// Variante Data Annotations</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">class</span> <span class="cm-def">Address</span> { ... }</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 445px;"></div><div class="CodeMirror-gutters" style="display: none; height: 445px;"></div></div></div></pre>
        <p>
          <span
            >Möglich ist auch, mehrere oder verschachtelte Owned Types zu
            verwenden.</span
          >
        </p>
        <pre
          class="md-fences md-end-block ty-contain-cm modeLoaded"
          spellcheck="false"
          lang="csharp"
        ><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="csharp"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 11px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">class</span> <span class="cm-def">Customer</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable-3">int</span> <span class="cm-variable">Id</span> { <span class="cm-keyword">get</span>; <span class="cm-keyword">set</span>; }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable">Address</span> <span class="cm-variable">BillingAddress</span> { <span class="cm-keyword">get</span>; <span class="cm-keyword">set</span>; }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable">Address</span> <span class="cm-variable">ShippingAddress</span> { <span class="cm-keyword">get</span>; <span class="cm-keyword">set</span>; }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">/* Ergibt:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">BillingAddress_street <span class="cm-tab" role="presentation" cm-text="	">  </span>(nvarchar(MAX))</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">BillingAddress_City<span class="cm-tab" role="presentation" cm-text="	"> </span><span class="cm-tab" role="presentation" cm-text="	">    </span>(nvarchar(MAX))</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">ShippingAddress_Street<span class="cm-tab" role="presentation" cm-text="	">  </span>(nvarchar(MAX))</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">ShippingAddress_City<span class="cm-tab" role="presentation" cm-text="	">    </span>(nvarchar(MAX))</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">*/</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 291px;"></div><div class="CodeMirror-gutters" style="display: none; height: 291px;"></div></div></div></pre>
        <h2 id="database-migrations"><span>Database Migrations</span></h2>
        <p>
          <span
            >Naiver Ansatz: Änderungen der Datenbank in einem Change Script
            festhalten. Probleme dabei:</span
          >
        </p>
        <ul>
          <li><span>keine manuelle Einflussnahme</span></li>
          <li><span>schwierig, sobald Daten vorhanden sind</span></li>
          <li>
            <span
              >Umbenennen von Spalten/Tabellen wie DROP / CREATE -&gt; möglicher
              Datenverlust</span
            >
          </li>
          <li>
            <span
              >Hinzufügen einer NOT NULL Spalte zwingt auch bestehende
              Datensätze, NOT NULL einzuhalten</span
            >
          </li>
        </ul>
        <p>
          <span
            >EF Core Ansatz: Modell anpassen, dann eine Migration erstellen.
            Diese wird als C# Klasse implementiert, die anschliessend reviewed
            und allenfalls korrigiert werden kann. Jede Migration implementiert
            die Funktion </span
          ><code>up()</code><span> und </span><code>down()</code
          ><span>
            und kann als Artefakt in der Versionsverwaltung abgespeichert
            werden. Deployment wie auch Rollback einfach auszuführen.</span
          >
        </p>
        <h3 id="erstellte-files"><span>Erstellte Files</span></h3>
        <p>
          <code>Migrations/&lt;timestamp&gt;\_Migration.cs</code><span> </span
          ><span>Eigentliche Migration</span>
          <code>Migrations/&lt;timestamp&gt;\_Migration.Designer.cs</code
          ><span> </span><span>Metadaten für Entity Framework</span>
          <code>Migrations/&lt;contextClassName&gt;ModelSnapshot.cs</code
          ><span> </span><span>Snapshot / Basis für nächste Migration</span>
        </p>
        <h3 id="tabelle"><span>Tabelle</span></h3>
        <p>
          <code>dbo.__EFMigrationsHistory</code
          ><span>
            zeigt eine Liste der aktuell auf die Datenbank angewendeten
            Migrations.</span
          >
        </p>
        <h3 id="befehle"><span>Befehle</span></h3>
        <figure>
          <table>
            <thead>
              <tr>
                <th><span>CLI [dotnet ef ...]</span></th>
                <th><span>Package Manager</span></th>
                <th><span>Beschreibung</span></th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><code>database drop</code></td>
                <td><code>Drop-Database</code></td>
                <td><span>Löscht die gesamte Datenbank</span></td>
              </tr>
              <tr>
                <td><code>database update</code></td>
                <td><code>Update-Database</code></td>
                <td>
                  <span
                    >Setzt den aktuellen Stand der Codebase in der Datenbank
                    um</span
                  >
                </td>
              </tr>
              <tr>
                <td><code>database update Init</code></td>
                <td>&nbsp;</td>
                <td>
                  <span
                    >Setzt die Datenbank auf den Stand der angegebenen
                    Migration</span
                  >
                </td>
              </tr>
              <tr>
                <td><code>migrations add Init</code></td>
                <td><code>Add-Migration &lt;name&gt;</code></td>
                <td>
                  <span>Legt eine neue Migration an zum aktuellen Stand </span
                  ><strong><span>der Codebase</span></strong>
                </td>
              </tr>
              <tr>
                <td><code>migrations list</code></td>
                <td>&nbsp;</td>
                <td>
                  <span>Zeigt eine Liste von verfügbaren Migrations an</span>
                </td>
              </tr>
              <tr>
                <td><code>migrations remove</code></td>
                <td><code>Remove-Migration</code></td>
                <td><span>Löscht die letzte Migration</span></td>
              </tr>
              <tr>
                <td>
                  <code
                    >migrations script &lt;migration-start&gt;
                    &lt;migration-end&gt;</code
                  >
                </td>
                <td><code>Script-Migration</code></td>
                <td>
                  <span
                    >Gibt auf der Konsole ein SQL-Skript aus, das die Änderungen
                    zwischen Migration-Start und Migration-End ausführt.
                    Vorwärts und Rückwärts möglich.</span
                  >
                </td>
              </tr>
              <tr>
                <td><code>dbcontext info</code></td>
                <td><code>Get-DbContext</code></td>
                <td>
                  <span>Liefert Informationen über einen DbContext Typen</span>
                </td>
              </tr>
              <tr>
                <td><code>dbcontext list</code></td>
                <td>&nbsp;</td>
                <td><span>Listet verfügbare DbContext Typen</span></td>
              </tr>
              <tr>
                <td><code>dbcontext scaffold</code></td>
                <td><code>Scaffold-DbContext</code></td>
                <td>
                  <span
                    >Erstellt einen DbContext und Entity Types für eine
                    bestehende Datenbank</span
                  >
                </td>
              </tr>
              <tr>
                <td>&nbsp;</td>
                <td><code>Get-Help EntityFramework</code></td>
                <td>
                  <span>Informationen über Entity Framework Commands</span>
                </td>
              </tr>
            </tbody>
          </table>
        </figure>
        <h3 id="c-api"><span>C# API</span></h3>
        <p>
          <span
            >Die C# API bietet diverse Operationen um Migrations programmatisch
            anzuwenden.</span
          >
        </p>
        <pre
          class="md-fences md-end-block ty-contain-cm modeLoaded"
          spellcheck="false"
          lang="csharp"
          style="break-inside: unset"
        ><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="csharp"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 11px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">using</span>(<span class="cm-variable">AngProjContext</span> <span class="cm-variable">context</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span>())</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">DatabaseFacade</span> <span class="cm-variable">database</span> <span class="cm-operator">=</span> <span class="cm-variable">context</span>.<span class="cm-variable">Database</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">// "Dev" Ansatz (löschen / neu erstellen)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">await</span> <span class="cm-variable">database</span>.<span class="cm-variable">EnsureDeletedAsync</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">await</span> <span class="cm-variable">database</span>.<span class="cm-variable">EnsureCreatedAsync</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">// Automatische Migration auf neuesten Stand</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">await</span> <span class="cm-variable">database</span>.<span class="cm-variable">MigrateAsync</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">// Migrations abfragen</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">IEnumerable</span><span class="cm-operator">&lt;</span><span class="cm-variable-3">string</span><span class="cm-operator">&gt;</span> <span class="cm-variable">migrations</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">migrations</span> <span class="cm-operator">=</span> <span class="cm-variable">database</span>.<span class="cm-variable">GetMigrations</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">migrations</span> <span class="cm-operator">=</span> <span class="cm-variable">database</span>.<span class="cm-variable">GetPendingMigrations</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">migrations</span> <span class="cm-operator">=</span> <span class="cm-variable">database</span>.<span class="cm-variable">GetAppliedMigrations</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">// Migration ausführen</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">IMigrator</span> <span class="cm-variable">m</span> <span class="cm-operator">=</span> <span class="cm-variable">context</span>.<span class="cm-variable">GetService</span><span class="cm-operator">&lt;</span><span class="cm-variable">IMigrator</span><span class="cm-operator">&gt;</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">m</span>.<span class="cm-variable">Migrate</span>(<span class="cm-string">"&lt;MigrationName&gt;"</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 546px;"></div><div class="CodeMirror-gutters" style="display: none; height: 546px;"></div></div></div></pre>
        <p>&nbsp;</p>
      </div>
    </div>
  </body>
</html>
